<?xml version="1.0" encoding="utf-8"?>
<body name="body" class="sys_normal" headerScript="var currentNode=null,roleNameIsExpaned=true;&#xA;var  operateType ,operateType1,operateType2 ,operateType3 ;&#xA;&#xA;&#xA;function verifyData(){&#xA;var f=true,k;&#xA;var s=InDetailWareGrid.getStore();&#xA;Ext.each(s.getModifiedRecords(), function(r) {&#xA;k=100;&#xA;  &#xA;if(r.get('ACCOUNT_NUM')!=r.get('CHECK_NUM'))&#xA;{&#xA;k=1;&#xA;}&#xA;  &#xA;&#xA;&#xA;if(k!=100)&#xA;{var i=s.indexOf(r);&#xA;&#xA;f=false;&#xA;extShowMessage('盘存记录只能修改一次，如果数据录入有误，请再次盘存！');&#xA;return false;&#xA;}&#xA;});&#xA;return f;&#xA;}" jsFiles="webbuilder/script/wbfilter.js" caption="盘存记录" createBody="true" extLastScript="bds.setValue(&quot;=&quot;);">
	<folder name="folder1"><extStore name="store" url="main?action=webbuilder/application/shipmanager/common/cangKuSelect.xwl"/><extStore name="InMainStore" url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/MainSelect.xwl"/><extStore name="InDetailStore" url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/DetailSelect.xwl"/><extAjax name="shengchengAjax" url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/MainInsert.xwl" out="menu" onSuccess="extCall(findMenu);"/><extAjax name="detailAjax" url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/PCSave.xwl" showMessage="true" onSuccess="InDetailStore.baseParams=extGetAllControlsValue('menu');&#xA;	InDetailStore.load({params:{start:0,limit:30}});" out="menu,InDetailGrid"/><extAjax name="mainUpdate"/><extAjax name="deleteZero" url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/pacunDeleteZero.xwl" out="menu"/><extAjax url="main?action=webbuilder/application/partmanager/partDevic/PanCunJL/startProcess.xwl" onSuccess="extShowMessage('发起成功！');InMainStore.reload();" onFailure="extShowMessage('发起失败！');" out="InMainGrid" name="ajaxStartProcess"/><extAjax name="ajaxViewprocess" url="main?action=WebContent/webbuilder/application/partmanager/partDevic/PanCunJL/viewProcess.xwl"/><extStore url="main?action=webbuilder/application/partmanager/wasteApply/wasteApply/selectprocess.xwl" autoLoad="true" name="selectprocess"/></folder><folder name="folder"><extNumber name="CHECK_NUM" maxValue="9999999" allowDecimals="true" decimalPrecision="2" autoShow="false"/><extColumnModel name="columnModel"><extColumn name="dd" caption="盘点单号" fieldName="STOCKH_ID"/><extColumn fieldName="STORAGE_NAM" name="STORAGE_NAMs" caption="仓库名称"/><extColumn fieldName="CHECK_NAM" name="CHECK_NAMs" caption="盘点人"/><extColumn type="datetime" fieldName="CHECK_DTE" caption="盘点时间" renderer="if(value==''||value==null)&#xA;{&#xA;        return  &quot;&quot;;&#xA;}else&#xA;{&#xA;        return  value.format('Y-m-d');  &#xA;      &#xA;     &#xA;}" name="CHECK_DTEs"/><extColumn fieldName="WF_STATUE" name="WF_STATUEs" caption="审核状态" renderer="if(value=='0')&#xA;return '未提交';&#xA;else if(value=='1')&#xA;return '待审批';&#xA;else if(value=='2')&#xA;return '通过';&#xA;else if(value=='3')&#xA;return '未通过';"/><extColumn name="column" caption="caption" fieldName="procdefid" hidden="true"/><extColumn name="column1" caption="caption" fieldName="processinstid" hidden="true"/></extColumnModel><extColumnModel name="columnModel1"><extColumn caption="类别" name="PARTS_TYPEs" fieldName="PARTS_TYPE"/><extColumn caption="代码" fieldName="PARTS_COD" name="PARTS_CODs" width="150"/><extColumn fieldName="C_PARTS_NAM" name="C_PARTS_NAMs" caption="物料名称" width="100"/><extColumn fieldName="STAND_TXT" caption="规格型号" name="STAND_TXTs"/><extColumn fieldName="ACCOUNT_NUM" caption="账面数量" align="right" name="ACCOUNT_NUMs"/><extColumn fieldName="CHECK_NUM" caption="盘点数量" editor="CHECK_NUM" name="CHECK_NUMs"/><extColumn fieldName="STOCK_RESULT" name="STOCK_RESULTs" caption="盘亏盘盈"/><extColumn fieldName="NOTE" caption="备注" name="NOTEs"/></extColumnModel><extColumnModel name="columnProcess"><extColumn name="username_" fieldName="username" caption="发起人" align="center" width="80"/><extColumn name="starttime_" fieldName="starttime" caption="发起时间" align="center" width="100"/><extColumn name="taskname_" fieldName="taskname" caption="审核阶段" align="center" width="100"/><extColumn name="checkman_" fieldName="checkman" caption="审核人" align="center" width="80"/><extColumn name="begintime_" fieldName="begintime" caption="到达日期" align="center" width="100"/><extColumn name="endtime_" fieldName="endtime" caption="完成日期" align="center" width="100"/><extColumn name="duration_" fieldName="duration" caption="过程耗时(H)" align="center" width="100"/><extColumn name="status_" fieldName="status" caption="状态" align="center" width="80"/></extColumnModel></folder><folder name="folder2"><extWindow closeAction="hide" frame="true" width="461" height="293" layout="absolute" name="InDetailWin" onHide="extResetAllControlsValue('InDetailWin');" onOk="if (!extVerifyAllControls('InDetailWin')) return;&#xA;&#xA;&#xA;&#xA;updateInDetail();" caption="盘存明细"><extLabel name="extLabel15" left="210" top="15" width="75" caption="名称："/><extTextField left="290" top="10" width="120" name="C_PM_NAM" hidden="false" disabled="true"/><extLabel name="extLabel17" left="15" top="45" width="70" caption="型号："/><extTextField left="90" top="40" width="120" name="MODEL_TXT" disabled="true"/><extLabel name="extLabel18" left="225" top="45" width="65" caption="规格："/><extTextField left="295" top="40" width="120" name="STAND_TXT" disabled="true"/><extLabel name="extLabel21" left="15" top="75" width="65" caption="账面数量："/><extNumber left="90" top="70" width="120" maxValue="999999" allowDecimals="true" decimalPrecision="2" name="ACCOUNT_NUM"/><extNumber left="295" top="70" width="120" maxValue="9999999" allowDecimals="true" decimalPrecision="2" name="CHECK_NUM2"/><extLabel name="extLabel25" left="30" top="105" width="55" caption="备注："/><extTextField left="90" top="100" width="325" name="NOTE" inputType="textArea" height="80"/><extLabel name="extLabel9" left="225" top="75" width="65" caption="盘点数量："/><extTextField left="125" top="190" width="120" hidden="true" name="STOCK_ID"/></extWindow><extWindow closeAction="hide" frame="true" name="processViewWindow" caption="审批进度" width="800" height="550" layout="absolute"><extTab activeTab="0" deferredRender="false" region="center" name="detailtab"><extPanel name="flowPanel" border="false" caption="审批明细" layout="absolute" width="801" height="462"><extGrid store="selectprocess" left="10" top="5" width="765" height="205" name="tasklist" columnsModel="columnProcess"/><extForm name="imagemodel" left="15" top="215" width="760" height="190"><image name="image"/></extForm></extPanel><extPanel border="false" layout="absolute" width="800" height="500" name="businessPanel" caption="明细"><extForm name="mainForm" left="10" top="10" width="770" height="79" layout="absolute" frame="true"><extLabel left="25" top="20" width="65" caption="盘点单号：" name="STOCKH_ID_LAB"/><extLabel left="235" top="20" width="70" caption="仓库名称：" name="STORAGE_NAM_LAB"/><extLabel left="450" top="20" width="70" name="CHECK_NAM_LAB" caption="盘点人："/><extTextField left="530" top="15" width="125" disabled="true" name="CHECK_NAM_" readOnly="true"/><extTextField left="90" top="15" width="135" readOnly="true" name="STOCKH_ID_" disabled="true"/><extTextField left="305" top="15" width="135" name="STORAGE_NAM_" readOnly="true" disabled="true"/><extTextField left="90" top="40" width="350" name="CHECK_DTE" readOnly="true" disabled="true"/><extLabel left="20" top="45" width="65" caption="盘点时间：" name="CHECK_DTE_LAB"/></extForm><extGrid left="10" top="105" width="770" height="355" columnsModel="columnModel1" name="detailgrid1" store="InDetailStore"/></extPanel></extTab></extWindow></folder><extMenu name="menu"><extLabel name="extLabel811" caption="仓库名称："/><extTextField name="storeNam"/><extLabel name="extLabel1" caption="开始时间："/><extDate name="begTim"/><extLabel name="extLabel2" html="-"/><extDate name="endTim"/><extMenuItem caption="查询" iconCls="icon_find" name="findMenu" onClick="if(storeNam.getValue()=='')&#xA;{&#xA;	extShowMessage('请选择仓库！');&#xA;	return;&#xA;	&#xA;}&#xA;InMainStore.baseParams=extGetAllControlsValue('menu');&#xA;InMainStore.load({params:{start:0,limit:30}});&#xA;InDetailStore.removeAll();"/><extLabel name="extLabel" caption="盘存日期："/><extDate name="sysTim"/><extMenuItem name="sCMeu" iconCls="icon_run" caption="生成" onClick="if(sysTim.getValue()=='')&#xA;{&#xA;	extShowMessage('生成盘存记录请输入盘存时间');&#xA;	return;&#xA;}&#xA;else&#xA;{&#xA;Ext.Msg.confirm('确认','如果已经生成过盘存记录，会重新生成，是否继续?',  function(btn) {&#xA;		                                         if (btn == &quot;yes&quot;)&#xA;			                                 shengchengAjax();&#xA;	                                      });	&#xA;&#xA;&#xA;}"/><extTextField name="STOCKH_ID" hidden="true"/><extTextField name="STORAGE_COD" hidden="true"/><extTextField name="numWhere" hidden="true" value=" and 1=1"/><extMenuItem name="startprocess" caption="发起流程" onClick="if (InMainGrid.getSelectionModel().getSelections().length != 1)&#xA;{&#xA;	extShowWarning('请选择一条数据。');&#xA;	return;&#xA;}else{	&#xA;	var record = InMainGrid.getSelectionModel().getSelected();&#xA;	ajaxStartProcess();&#xA;}" iconCls="icon_edit"/><extMenuItem caption="流程进度" name="showprocess" onClick="if (InMainGrid.getSelectionModel().getSelections().length != 1)&#xA;{&#xA;	extShowWarning('请选择一条数据。');&#xA;	return;&#xA;}else{	&#xA;	var record = InMainGrid.getSelectionModel().getSelected();&#xA;	var wfstatus=record.data.WF_STATUE;&#xA;	if(wfstatus==1){&#xA;		Get('image').src='/PartManager/modelFlowImage_getProcessTask.do?processinstid='+record.data.processinstid;&#xA;		var  wheresql=&quot; where  procinstid='&quot;+record.data.processinstid+&quot;' &quot;;&#xA;		selectprocess.baseParams.whereSql = wheresql;&#xA;		selectprocess.load({params:{start:0,limit:30}});&#xA;&#xA;	        InDetailStore.baseParams.putNo= record.data.STOCKH_ID ;&#xA;		InDetailStore.load({params:{start:0,limit:30}});&#xA;&#xA;		CHECK_NAM_.setValue(record.data.CHECK_NAM);&#xA;		CHECK_DTE.setValue(record.data.CHECK_DTE);&#xA;		STOCKH_ID_.setValue(record.data.STOCKH_ID);&#xA;		STORAGE_NAM_.setValue(record.data.STORAGE_NAM);&#xA;		processViewWindow.show();&#xA;&#xA;	}else{&#xA;		extShowWarning('尚未发起审批。');&#xA;	}&#xA;}" iconCls="icon_edit"/></extMenu><extMenu name="menu1"><extMenuItem iconCls="icon_save" caption="保存" hint="盘存操作只能修改一次，如果数据有误，请重新做一次盘存" onClick="detailAjax();" name="saveMenu"/><extLabel name="extLabel3" caption="数量"/><extComboBox mode="local" mapKey="BDS" displayField="KEY_TEXT" valueField="KEY_ID" width="50" name="bds"/><extLabel name="extLabel4" caption="-"/><extNumber width="40" name="nB" value="0"/><extMenuItem name="menuItem" caption="查询零库存" onClick="var bdss = bds.getValue();&#xA;if (bdss =='1')&#xA;  { bdss ='&gt;';}&#xA;else if (bdss =='2')&#xA; {  bdss ='&gt;=';}&#xA;else if( bdss =='3')&#xA; {  bdss ='=';}&#xA;else if (bdss =='4')&#xA; {  bdss ='&lt;';}&#xA;else if (bdss =='5')&#xA;{   bdss ='&lt;=';}&#xA;&#xA;;&#xA;var numb = nB.getValue();&#xA;&#xA;InDetailStore.baseParams.numWhere=&quot;  AND ACCOUNT_NUM  &quot;	+ bdss +  numb &#xA;InDetailStore.load({params:{start:0,limit:30}});" iconCls="icon_find"/><extMenuItem caption="删除零库存" iconCls="icon_delete" onClick="Ext.Msg.confirm('确认','是否删除库存为零的数据?',  function(btn) {&#xA;		                                         if (btn == &quot;yes&quot;)&#xA;			                                 deleteZero();&#xA;	                                      });" name="deleteZeroBtn"/></extMenu><extViewPort name="viewPort" layout="border"><extPanel name="panel11" border="false" region="west" width="200" layout="fit" height="100%" caption="代码类别树" collapsible="true" split="true"><extTree name="tree" autoScroll="true" onClick="Ext.getCmp(&quot;storeNam&quot;).setValue(node.text);&#xA;p=node;" remoteUrl="main?action=webbuilder/application/partmanager/partDevic/WLOutWare/jsonQuery.xwl" onBeforeLoad="control.baseParams.id=node.id;"/></extPanel><extPanel name="panel1" border="false" region="center" layout="border" tbar="menu"><extPanel name="panel2" border="false" layout="fit" region="north" height="200"><extGrid name="InMainGrid" columnsModel="columnModel" onCellClick="if (InMainGrid.getSelectionModel().getSelections().length != 1)&#xA;{&#xA;	extShowWarning('请选择一个有效的条目。');&#xA;	return;&#xA;}else{&#xA;	var record = InMainGrid.getSelectionModel().getSelected();&#xA;	STOCKH_ID.setValue(record.get('STOCKH_ID'));&#xA;	var  s=record.get('CHECK_STATE');&#xA;	if(s=='1')&#xA;	{&#xA;	extSetDisabled(saveMenu,true);&#xA;&#xA;	}&#xA;	else&#xA;	{&#xA;		extSetDisabled(saveMenu,false);&#xA;&#xA;	}&#xA;	InDetailStore.baseParams=extGetAllControlsValue('menu');&#xA;	InDetailStore.load({params:{start:0,limit:30}});&#xA;&#xA;}" store="InMainStore" loadStore="false" pageSize="30"/></extPanel><extPanel name="panel3" border="false" region="center" layout="fit" tbar="menu1"><extGrid name="InDetailGrid" loadStore="false" columnsModel="columnModel1" store="InDetailStore" clicksToEdit="1" canEdit="true" submitMode="modified" pageSize="30"/></extPanel></extPanel></extViewPort><extScript name="extScript" extHeader="var d=new Date();&#xA;d.setDate(d.getDate()+5)&#xA;Ext.getCmp('endTim').setValue(d);&#xA;d.setDate(d.getDate()-10);&#xA;Ext.getCmp('begTim').setValue(d);"/></body>
